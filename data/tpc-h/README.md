# TPC-H

## Data

Copy data generated by TPCH-H dbgen tool to this directory. For example:

```
tpc-h
  ├── README.md
  ├── denormalize.py
  └── sf1
      ├── customer.tbl
      ├── lineitem.tbl
      ├── nation.tbl
      ├── orders.tbl
      ├── part.tbl
      ├── partsupp.tbl
      ├── region.tbl
      └── supplier.tbl
```

Run the following command to generate the denormalized data:

```bash
python denormalize.py sf1 --out ./sf1/denormalized.csv
```

You can also change the output extension to `.parquet` to generate the result as parquet files.

```bash
python denormalize.py sf1 --out ./sf1/denormalized.parquet
```

## Queries

Put the following script in the same directory as the `qgen` executable. This script will generate the queries from the templates.

```bash
#!/bin/bash

set -e

usage() {
    echo "Usage: ./run_qgen.sh [-n <number of queries per template>] <template path> <output path>"
    exit 1
}

NUM_QUERIES=1
while getopts n: flag
do
    case "${flag}" in
        n) NUM_QUERIES=${OPTARG};;
    esac
done
shift $((OPTIND-1))

if [ "$#" -ne 2 ]; then
    usage
fi

export DSS_QUERY=$1
OUT=$2

for file in $DSS_QUERY/*.sql; do
  # Get the filename without the extension
  filename=$(basename -- "$file")
  filename="${filename%.*}"

  for i in $(seq 1 $NUM_QUERIES); do
    seed=$(( $(date +%s) + $i ))
    ./qgen -c $filename -r $seed > "$OUT/$filename.$i.sql"
    echo Query written to "$OUT/$filename.$i.sql"
  done
done
```

Example usage (`$QDTREE` is the root directory of the qdtree repository):

```bash
./run_qgen.sh -n 10 $QDTREE/data/tpc-h/templates $QDTREE/data/tpc-h/queries
```
