# TPC-H

## Data

Copy data generated by TPCH-H dbgen tool to this directory. For example:

```
tpc-h
  ├── README.md
  ├── denormalize.py
  └── sf1
      ├── customer.tbl
      ├── lineitem.tbl
      ├── nation.tbl
      ├── orders.tbl
      ├── part.tbl
      ├── partsupp.tbl
      ├── region.tbl
      └── supplier.tbl
```

Run the following command to generate the denormalized data:

```bash
python denormalize.py sf1 --out ./sf1/denormalized.csv
```

You can also change the output extension to `.parquet` to generate the result as parquet files.

```bash
python denormalize.py sf1 --out ./sf1/denormalized.parquet
```

## Queries

Put the following script in the same directory as the `qgen` executable. This script will generate the queries from the templates.

```bash
#!/bin/bash

set -e

usage() {
    echo "Usage: ./run_qgen.sh [OPTIONS] <template path> <output path>"
    echo "Options:"
    echo "  -n <num_queries>  Number of queries to generate for each template. Default: 1"
    echo "  -s <scale_factor> Scale factor to use for the queries. Default: 1"
    exit 1
}

NUM_QUERIES=1
SCALE_FACTOR=1

# Get the flags from the command line
while getopts ":n:s:" opt; do
  case $opt in
    n)
      NUM_QUERIES=$OPTARG
      ;;
    s)
      SCALE_FACTOR=$OPTARG
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      usage
      ;;
  esac
done

# Get the positional arguments
shift $((OPTIND-1))

# Check that the correct number of arguments were supplied
if [ "$#" -ne 2 ]; then
    usage
fi

export DSS_QUERY=$1
OUT=$2

for file in $DSS_QUERY/*.sql; do
  # Get the filename without the extension
  filename=$(basename -- "$file")
  filename="${filename%.*}"

  for i in $(seq 1 $NUM_QUERIES); do
    # Set the variable seed to current time + i
    seed=$(( $(date +%s) + $i ))
    ./qgen -c $filename -r $seed -s $SCALE_FACTOR > "$OUT/$filename.$i.sql"
    echo Query written to "$OUT/$filename.$i.sql"
  done
done
```

Example usage (`$QDTREE` is the root directory of the qdtree repository):

```bash
./run_qgen.sh -n 10 $QDTREE/data/tpc-h/templates $QDTREE/data/tpc-h/queries
```
